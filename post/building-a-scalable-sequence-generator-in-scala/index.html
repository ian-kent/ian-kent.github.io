<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="Reactive, Scala, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Building a scalable sequence generator (in Scala) : iankent.uk"/>
<meta property="og:site_name" content="Ian Kent"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://localhost:1313/post/building-a-scalable-sequence-generator-in-scala/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2014-02-23"/>
<meta property="article:modified_time" content="2014-02-23"/>



<meta property="article:tag" content="Reactive">
<meta property="article:tag" content="Scala">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@iankent">
<meta name="twitter:title" content="Building a scalable sequence generator (in Scala) : iankent.uk">
<meta name="twitter:creator" content="@iankent">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="iankent.uk">


    <base href="http://localhost:1313">
    <title> Building a scalable sequence generator (in Scala) - iankent.uk </title>
    <link rel="canonical" href="http://localhost:1313/post/building-a-scalable-sequence-generator-in-scala/">
    

    <link href='http://fonts.googleapis.com/css?family=Fjalla+One|Open+Sans:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-spf13-3" id="logo"> </div></a>
    </figure>
    <div id="byline">by Ian Kent</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/post/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blog </span>
            </a>
            </li>
            <li>
            <a href="/project/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> code </span>
            </a>
            </li>
            <li>
            <a href="/presentation/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://stevefrancia.com">
                <span class="icon"> <i aria-hidden="true" class="icon-13"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=Building%20a%20scalable%20sequence%20generator%20%28in%20Scala%29-http%3a%2f%2flocalhost%3a1313%2fpost%2fbuilding-a-scalable-sequence-generator-in-scala%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fpost%2fbuilding-a-scalable-sequence-generator-in-scala%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2flocalhost%3a1313%2fpost%2fbuilding-a-scalable-sequence-generator-in-scala%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2flocalhost%3a1313%2fpost%2fbuilding-a-scalable-sequence-generator-in-scala%2f&title=Building%20a%20scalable%20sequence%20generator%20%28in%20Scala%29&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2flocalhost%3a1313%2fpost%2fbuilding-a-scalable-sequence-generator-in-scala%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fpost%2fbuilding-a-scalable-sequence-generator-in-scala%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                        <li> <a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fpost%2fbuilding-a-scalable-sequence-generator-in-scala%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="icon icon-stumbleupon"></span>StumbleUpon</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://feeds.feedburner.com/spf13" target="_blank" title="Subscribe by RSS" class="rss"><span class="icon icon-feed-2"></span>RSS</a> </li>
                        <li> <a href="http://www.twitter.com/iankent" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://github.com/ian-kent" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
        </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">Building a scalable sequence generator (in Scala)</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p>Building a scalable sequence generator was more difficult than I&rsquo;d anticipated.</p>

<h3 id="the-challenge:1488174a7a6bea43933aad3fecc4c536">The challenge</h3>

<ul>
<li><p>Build a scalable sequence generator (must scale out and provide resilience)</p></li>

<li><p>Master sequence number is stored in MongoDB, updated atomically using find and modify</p></li>

<li><p>Sequence numbers must never be repeated (but strict ordering isn&rsquo;t required)</p></li>
</ul>

<h3 id="the-problem:1488174a7a6bea43933aad3fecc4c536">The problem</h3>

<p>Since the sequence number is a single value stored in a single document in a single collection, the document gets locked on every request. MongoDB can&rsquo;t help with scaling:</p>

<ul>
<li><p>Starting multiple instances of our sequence generator doesn&rsquo;t help, they all need to lock the same document</p></li>

<li><p>Multiple MongoDB nodes doesn&rsquo;t help - we&rsquo;d need <a href="http://docs.mongodb.org/manual/core/write-concern/#replica-acknowledged">replica acknowledged write concern</a> to avoid duplicate sequence numbers</p></li>
</ul>

<h3 id="the-solution:1488174a7a6bea43933aad3fecc4c536">The solution</h3>

<p>The solution is to take batches of sequence numbers from MongoDB, multiplying the scalability - for example, using a batch size of 10 means we can run (approximately) 10 instances of our sequence generator to our 1 MongoDB document, though any instance failure could waste up to 10 sequence numbers.</p>

<p>Using batches also dramatically improves our performance - we make far fewer MongoDB requests, generating less network traffic and reducing service response times.</p>

<h4 id="the-unscalable-sequence-generator:1488174a7a6bea43933aad3fecc4c536">The unscalable sequence generator</h4>

<p>Building an unscalable sequence generator is easy. We can just find and modify the next sequence, MongoDB takes care of the rest.</p>

<p>An implementation might look a bit like this:</p>

<pre><code>&lt;code&gt;object UnscalableSequenceGenerator extends App {
  // the master sequence number
  var seq = 0

  def nextSeq : Future[Int] = future { blocking {
    // pretend we're doing a find and modify asynchronously
    Thread.sleep(30)
    this.synchronized {
      seq = seq + 1
      seq
    }
  } }

  // simulate calling our HTTP service 100 times
  for(i &lt;- 1 to 100) {
    nextSeq map { j =&gt;
      // pretend we're doing something useful with the sequence number
      print(s&quot;$j &quot;)
      if(i % 10 == 0) println
    }
  }

  Thread.sleep(5000)
}
&lt;/code&gt;
</code></pre>

<p>Running that example produces output like this (the exact ordering of numbers may be different):</p>

<pre><code>&lt;code&gt;2 3 1 4 5 7 6 8 9 10 11 12
14 13 16 17 15 19 18 21 22 20 24 23 25
26 27 28 30 29
31 32 34 33 36 35 37 38 39 40 41 43 42
44 46 45 47 48 49 50 51 52
53 55 54 56 57 58 60 59
62 61 63 64 65 66 67 68 69 70
71 72 74 73 75 76 78 77 80 79 81
82 83 85 84 86 87 89 88 90 91
93 95 92 96 97 94 99 98 100
&lt;/code&gt;
</code></pre>

<p>No duplicates, but it&rsquo;s not scalable, and the performance is terrible.</p>

<h4 id="making-it-scalable:1488174a7a6bea43933aad3fecc4c536">Making it scalable</h4>

<p>To make it scalable (and get a performance boost), we can use sequence number batches. But that turned out to be more difficult than I&rsquo;d expected.</p>

<p>The first attempt looked a bit like this:</p>

<pre><code>&lt;code&gt;object BatchedSequenceGenerator extends App {
  // the master sequence number and batch size
  var seq = 0
  val batch_size = 10

  // our current sequence and maximum sequence numbers
  var local_seq = 0
  var local_max = 0

  def newBatch : Future[Int] = future { blocking {
    // pretend we're doing a find and modify asynchronously
    Thread.sleep(30)
    this.synchronized {
        seq = seq + 10
        seq
    }
  } }

  def nextSeq : Future[Int] = {
    if(local_seq &gt;= local_max) {
      // Get a new batch of sequence numbers
      newBatch map { new_max =&gt;
        // Update our local sequence
        local_max = new_max
        local_seq = local_max - batch_size
        local_seq = local_seq + 1
        local_seq
      }
    } else {
      // Use our local sequence number
      val next_seq = local_seq
      local_seq = local_seq + 1
      future { next_seq }
    }
  }

  // simulate calling our HTTP service 100 times
  for(i &lt;- 1 to 100) nextSeq map { j =&gt;
    // pretend we're doing something useful with the sequence number
    print(s&quot;$j &quot;)
    if(i % 10 == 0) println
  }

  Thread.sleep(5000)
}
&lt;/code&gt;
</code></pre>

<p>While it does at least take batches of sequence numbers, we get the following unexpected but understandable output:</p>

<pre><code>&lt;code&gt;11 1 41 61 71 91 21 31 121 181 191 131 141 151 161 171 201 211 221
101 81 111 51
231 251 241 261 271 281 291 301
311 321 331 341 351 361 371 381
391 401 411 421 441 431 451 461 471
481 491 501 511 521 531 541 551
561 571 581 591 601 611 621 631 641 651 661 671 681 701 701 731 731 721
741 751 761 791 781 771 801 811 821 831 841
861 871 851 881 891 911
901 921 931 951 961 941 971
991 981
&lt;/code&gt;
</code></pre>

<p>We&rsquo;re only using 1/10th of each batch, and we get to 991 in only 100 requests. It&rsquo;s no more scalable than the unbatched version.</p>

<p>It should probably have been obvious, but the problem is caused by requests arriving between requesting a new batch and getting a response:</p>

<ul>
<li><p>The 10th request gives out the last local sequence number</p></li>

<li><p>The 11th request gets a new batch asynchronously</p></li>

<li><p>The 12th request arrives before we get a new batch, and requests another new batch asynchronously</p></li>

<li><p>We get the 11th request batch, reset our sequence numbers and return a sequence</p></li>

<li><p>We get the 12th request batch, and again reset our sequence numbers and return a sequence, wasting the rest of the previous batch</p></li>
</ul>

<p>To fix it, we need the 12th request to wait for the 11th request to complete first.</p>

<h4 id="making-it-work:1488174a7a6bea43933aad3fecc4c536">Making it work</h4>

<p>This was the tricky bit - implementing it led me down a road of endless compiler errors, but the idea was simple.</p>

<p>When we call <code>nextSeq</code>, we need to know if a new batch request is pending. If it is, instead of requesting a new batch, we need to wait for the existing request to complete, otherwise handle the request as normal.</p>

<p>We can do this by chaining futures together, keeping track of whether a batch request is currently in progress.</p>

<p>It&rsquo;s a fairly simple change to our batched sequence generator (or at least, in hindsight it is):</p>

<pre><code>&lt;code&gt;object BatchedSequenceGenerator extends App {
  // the master sequence number and batch size
  var seq = 10
  val batch_size = 10

  // our current sequence and maximum sequence numbers
  var local_seq = 0
  var local_max = 10
  var pending : Option[Future[Int]] = None

  def newBatch : Future[Int] = future { blocking {
    // pretend we're doing a find and modify asynchronously
    Thread.sleep(30)
    this.synchronized {
      seq = seq + batch_size
      seq
    }
  } }

  def nextSeq : Future[Int] = this.synchronized {
    pending match {
      case None =&gt;
        if(local_seq &gt;= local_max) {
          // Get a new batch of sequence numbers
          pending = Some(newBatch map { new_max =&gt;
            // Update our local sequence
            local_max = new_max
            local_seq = local_max - batch_size + 1
            local_seq
          })
          // Clear the pending future once we've got the batch
          pending.get andThen { case _ =&gt; pending = None }
        } else {
          // Use our local sequence number
          local_seq = local_seq + 1
          val seq = local_seq
          future(seq)
        }
      case Some(f) =&gt;
        // Wait on the pending future
        f flatMap { f =&gt; nextSeq }
    }
  }

  // simulate calling our HTTP service 100 times
  for(i &lt;- 1 to 100) nextSeq map { j =&gt;
    // pretend we're doing something useful with the sequence number
    print(s&quot;$j &quot;)
    if(i % 10 == 0) println
  }

  Thread.sleep(5000)
}
&lt;/code&gt;
</code></pre>

<p>And running that example generates output like this:</p>

<pre><code>&lt;code&gt;3 5 6 2 7 8 9 10
4 1 13 11 12 14 15 17 19 20
16 18 23 21 24 26 27 28 29 30 22
25 34 35 31 33 37 38 39 40
32 36 45 41 44 46 47 48 43
49 50 42 52 53 55 51 60 54 56
57 58 59 62
64 70 63 61 65 66 67 68 69 72 75 71
73 74 76 77 78 80 79 82 83 85 84 86 87 81
89 88 90 92 95 93 99 98 100 97
96 91 94
&lt;/code&gt;
</code></pre>

<p>The changes we made are straightforward:</p>

<ul>
<li><p>When we request a new sequence number, check if a pending future exists</p>

<ul>
<li><p>If it does, wait on that and return a new call to nextSeq</p></li>

<li><p>If not, check if a new batch is required</p>

<ul>
<li><p>If it is, store the future before returning</p></li>

<li><p>It not, use the existing batch as normal</p></li>
</ul></li>
</ul></li>
</ul>

<p>A limitation of this approach - if we have a sufficiently small batch size with a high volume of requests, the considerable number of chained futures could potentially cause out of memory errors.</p>

<p>Getting it to work felt like an achievement, but I&rsquo;m still not happy with the code. It looks like there should be a nicer way to do it, and it doesn&rsquo;t feel all that functional, but I can&rsquo;t see it yet!</p>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Sun Feb 23, 2014 </h4>
          <h5 id="wc"> 1500 Words </h5>
          <h5 id="readtime"> Read in about 7 Min </h5>
        </section>
        <ul id="categories">
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://localhost:1313/tags/reactive">Reactive</a> </li>
          
            <li> <a href="http://localhost:1313/tags/scala">Scala</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;<a class="previous" href="http://localhost:1313/post/the-automation-what-for/"><i class="icon-arrow-left"></i> The automation what-for</a><br>
        </section><section id="next">
            &nbsp;<a class="next" href="http://localhost:1313/post/quick-start-with-perl-and-mojolicious/">Quick start with Perl and Mojolicious <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4> 
                Steve Francia is the Chief Developer
                Advocate for <a href="http://mongodb.com">MongoDB</a>. He is a open
                source contributor and author of <a
                href="http://vim.spf13.com">spf13-vim</a>, <a
                href="http://hugo.spf13.com">Hugo</a> and <a
                href="http://github.com/spf13/cobra">Cobra</a>. You can find him on <a href="http://twitter.com">Twitter</a>,
                <a href="http://github.com/spf13">Github</a>, and <a title="Author: Steve Francia on Google+" rel="author"
                href="https://plus.google.com/+SteveFrancia/posts?rel=author"
                target="_blank">Google+</a>.
        </section>
    </div>

</aside>

<meta itemprop="wordCount" content="1461">
<meta itemprop="datePublished" content="2014-02-23">
<meta itemprop="url" content="http://localhost:1313/post/building-a-scalable-sequence-generator-in-scala/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'iankent';
    var disqus_identifier = 'http:\/\/localhost:1313\/post\/building-a-scalable-sequence-generator-in-scala\/';
    var disqus_title = 'Building a scalable sequence generator (in Scala)';
    var disqus_url = 'http:\/\/localhost:1313\/post\/building-a-scalable-sequence-generator-in-scala\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2014-15 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Ian Kent.</span></span>
    <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons Attribution">Some rights reserved</a>;
    please attribute properly and link back. <br>
    Powered by <a href="http://hugo.spf13.com">Hugo</a>.
        Hosted by <a href="https://pages.github.com/">GitHub Pages</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47956770-1', 'auto');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>
<script>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

