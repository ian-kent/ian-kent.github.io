<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="AJAX, CORS, Play framework, Scala, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Globally handling OPTIONS requests in Play Framework : spf13.com"/>
<meta property="og:site_name" content="spf13 is Steve Francia"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://localhost:1313/globally-handling-options-requests-in-play-framework/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2014-02-11"/>
<meta property="article:modified_time" content="2014-02-11"/>



<meta property="article:tag" content="AJAX">
<meta property="article:tag" content="CORS">
<meta property="article:tag" content="Play framework">
<meta property="article:tag" content="Scala">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@spf13">
<meta name="twitter:title" content="Globally handling OPTIONS requests in Play Framework : spf13.com">
<meta name="twitter:creator" content="@spf13">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="spf13.com">



    <base href="http://localhost:1313">
    <title> Globally handling OPTIONS requests in Play Framework - spf13.com </title>
    <link rel="canonical" href="http://localhost:1313/globally-handling-options-requests-in-play-framework/">
    

    <link href='http://fonts.googleapis.com/css?family=Fjalla+One|Open+Sans:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-spf13-3" id="logo"> </div></a>
    </figure>
    <div id="byline">by Steve Francia</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/post/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blog </span>
            </a>
            </li>
            <li>
            <a href="/project/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> code </span>
            </a>
            </li>
            <li>
            <a href="/presentation/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://stevefrancia.com">
                <span class="icon"> <i aria-hidden="true" class="icon-13"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=Globally%20handling%20OPTIONS%20requests%20in%20Play%20Framework-http%3a%2f%2flocalhost%3a1313%2fglobally-handling-options-requests-in-play-framework%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fglobally-handling-options-requests-in-play-framework%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2flocalhost%3a1313%2fglobally-handling-options-requests-in-play-framework%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2flocalhost%3a1313%2fglobally-handling-options-requests-in-play-framework%2f&title=Globally%20handling%20OPTIONS%20requests%20in%20Play%20Framework&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2flocalhost%3a1313%2fglobally-handling-options-requests-in-play-framework%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fglobally-handling-options-requests-in-play-framework%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                        <li> <a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fglobally-handling-options-requests-in-play-framework%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="icon icon-stumbleupon"></span>StumbleUpon</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://feeds.feedburner.com/spf13" target="_blank" title="Subscribe by RSS" class="rss"><span class="icon icon-feed-2"></span>RSS</a> </li>
                        <li> <a href="http://www.twitter.com/spf13" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/stevefrancia" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/stevefrancia" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/spf13" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="http://gplus.to/spf13" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://slideshare.com/spf13" target="_blank" title="SlideShare" class="slideshare"><span class="icon icon-slideshare"></span>SlideShare</a> </li>
                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
        </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">Globally handling OPTIONS requests in Play Framework</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p>If you&rsquo;re using AJAX to talk to a Play Framework application, you&rsquo;ll probably need to respond to OPTIONS requests and might need to return the correct access control (CORS) headers.</p>

<p>In a controller, we can easily define a handler to accept OPTIONS requests:</p>

<pre><code>&lt;code&gt;def headers = List(
  &quot;Access-Control-Allow-Origin&quot; -&gt; &quot;*&quot;,
  &quot;Access-Control-Allow-Methods&quot; -&gt; &quot;GET, POST, OPTIONS, DELETE, PUT&quot;,
  &quot;Access-Control-Max-Age&quot; -&gt; &quot;3600&quot;,
  &quot;Access-Control-Allow-Headers&quot; -&gt; &quot;Origin, Content-Type, Accept, Authorization&quot;,
  &quot;Access-Control-Allow-Credentials&quot; -&gt; &quot;true&quot;
)

def options = Action { request =&gt;
  NoContent.withHeaders(headers : _*)
}
&lt;/code&gt;
</code></pre>

<p>And we can call our new options handler from our routes file, but this has a few problems. We either need to implement an options handler for every route, or we send the same response whatever route we have, even if it doesn&rsquo;t exist.</p>

<h3 id="per-route:690e640b2fe5a8e8798609567de62b3e">Per-route</h3>

<p>If you want to respond on a per-route basis, that typically requires one additional line in your routes file for every route you define:</p>

<pre><code>&lt;code&gt;GET / controllers.Application.index
OPTIONS / controllers.Application.options
&lt;/code&gt;
</code></pre>

<h3 id="globally:690e640b2fe5a8e8798609567de62b3e">Globally</h3>

<p>Or, if you don&rsquo;t mind sending the same headers back for every OPTIONS request (even if the route doesn&rsquo;t really exist), there&rsquo;s a cheat:</p>

<pre><code>&lt;code&gt;OPTIONS / controllers.Application.rootOptions
OPTIONS /*url controllers.Application.options(url: String)
&lt;/code&gt;
</code></pre>

<p>and change your controller options handler to:</p>

<pre><code>&lt;code&gt;def rootOptions = options(&quot;/&quot;)   
def options(url: String) = Action { request =&gt;
  NoContent.withHeaders(headers : _*)
}
&lt;/code&gt;
</code></pre>

<p>You can still override the global OPTIONS per-route by adding additional routes before the wildcard, for example:</p>

<pre><code>&lt;code&gt;OPTIONS /foo controllers.Application.someCustomOptions
OPTIONS / controllers.Application.rootOptions
OPTIONS /*url controllers.Application.options(url: String)
&lt;/code&gt;
</code></pre>

<h3 id="or-we-can-abuse-play-framework-the-best-way:690e640b2fe5a8e8798609567de62b3e">Or we can abuse Play Framework - the best way!</h3>

<p>Play Framework doesn&rsquo;t like to expose its routing, making it difficult to inspect the routing table once its been created. But it is possible! Doing that, we can globally handle OPTIONS requests but dynamically respond based on URL (or even other request parameters).</p>

<p>For this example, we&rsquo;ll work out the <code>Allow</code> header so we can return a 204 response if the route would normally exist, but a 404 response if it wouldn&rsquo;t.</p>

<p>This is the example routes file:</p>

<pre><code>&lt;code&gt;GET /           controllers.Application.index
GET /foo        controllers.Application.foo
OPTIONS /       controllers.Application.rootOptions
OPTIONS /*url   controllers.Application.options(url: String)
&lt;/code&gt;
</code></pre>

<p>When sending OPTIONS requests, we want to respond with 204 and <code>Allow: GET, OPTIONS</code> for <code>/</code> and <code>/foo</code>, but respond with 404 for everything else.</p>

<h4 id="getting-the-methods-available-for-a-url:690e640b2fe5a8e8798609567de62b3e">Getting the methods available for a URL</h4>

<p>Play Framework gives us a convenient function - <code>handlerFor</code> - which is normally used to route requests to a handler. For this to work, you&rsquo;ll need to add an import:</p>

<pre><code>&lt;code&gt;import play.api.Play.current
&lt;/code&gt;
</code></pre>

<p>We can then define a <code>getMethods</code> function, which given a request will return a list of available methods. It does this by asking Play Framework to route new requests with modified method parameters. If a handler is found, the method is added to the list. The list is also cached for future requests.</p>

<pre><code>&lt;code&gt;val methodList = List(&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;PATCH&quot;)
def getMethods(request: Request[AnyContent]) : List[String] = {
  Cache.getOrElse[List[String]](&quot;options.url.&quot; + request.uri) {
    for(m &lt;- methodList; if Play.application.routes.get.handlerFor(new RequestHeader {
      val remoteAddress = request.remoteAddress
      val headers = request.headers
      val queryString = request.queryString
      val version = request.version
      val method = m
      val path = request.path
      val uri = request.uri
      val tags = request.tags
      val id: Long = request.id
    }).isDefined) yield m
  }
}
&lt;/code&gt;
</code></pre>

<p>We can then update our options action to use the new method list:</p>

<pre><code>&lt;code&gt;def options(url: String) = Action { request =&gt;
  val methods = List(&quot;OPTIONS&quot;) ++ getMethods(request)
  if(methods.length &gt; 1)
    NoContent.withHeaders(List(&quot;Allow&quot; -&gt; methods.mkString(&quot;, &quot;)) : _*)
  else
    NotFound
}
&lt;/code&gt;
</code></pre>

<p>We add OPTIONS back in, and if we have more than one method we return the Allow header, otherwise a 404 response.</p>

<p>We could instead cache the entire response for a given URI, but caching just the method list gives us the flexibility to set other headers which may be more dynamic, for example Last-Modified. Even the current caching might be too restrictive if the available methods depends on other request parameters.</p>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Tue Feb 11, 2014 </h4>
          <h5 id="wc"> 700 Words </h5>
          <h5 id="readtime"> Read in about 4 Min </h5>
        </section>
        <ul id="categories">
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://localhost:1313/tags/ajax">AJAX</a> </li>
          
            <li> <a href="http://localhost:1313/tags/cors">CORS</a> </li>
          
            <li> <a href="http://localhost:1313/tags/play-framework">Play framework</a> </li>
          
            <li> <a href="http://localhost:1313/tags/scala">Scala</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;<a class="previous" href="http://localhost:1313/quick-start-with-scala-and-play-framework/"><i class="icon-arrow-left"></i> Quick start with Scala and Play Framework</a><br>
        </section><section id="next">
            &nbsp;<a class="next" href="http://localhost:1313/action-composition-in-play-framework/">Action composition in Play Framework <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4> 
                Steve Francia is the Chief Developer
                Advocate for <a href="http://mongodb.com">MongoDB</a>. He is a open
                source contributor and author of <a
                href="http://vim.spf13.com">spf13-vim</a>, <a
                href="http://hugo.spf13.com">Hugo</a> and <a
                href="http://github.com/spf13/cobra">Cobra</a>. You can find him on <a href="http://twitter.com">Twitter</a>,
                <a href="http://github.com/spf13">Github</a>, and <a title="Author: Steve Francia on Google+" rel="author"
                href="https://plus.google.com/+SteveFrancia/posts?rel=author"
                target="_blank">Google+</a>.
        </section>
    </div>

</aside>

<meta itemprop="wordCount" content="644">
<meta itemprop="datePublished" content="2014-02-11">
<meta itemprop="url" content="http://localhost:1313/globally-handling-options-requests-in-play-framework/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'iankent';
    var disqus_identifier = 'http:\/\/localhost:1313\/globally-handling-options-requests-in-play-framework\/';
    var disqus_title = 'Globally handling OPTIONS requests in Play Framework';
    var disqus_url = 'http:\/\/localhost:1313\/globally-handling-options-requests-in-play-framework\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-14 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Steve Francia.</span></span>
    <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons Attribution">Some rights reserved</a>; 
    please attribute properly and link back. <br>
    Powered by <a href="http://hugo.spf13.com">Hugo</a>.
        Hosted by <a href="http://servergrove.com">ServerGrove</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-7131036-1', 'spf13.com');
  ga('require', 'linkid', 'linkid.js');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>
</body>
</html>

